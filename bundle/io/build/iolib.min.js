/*
  2014 Pinky Sharma  {@link http://vidyamantra.com}
 @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
var io={cfg:{},sock:null,wsuri:null,response:{},auth:!1,error:null,uniquesids:null,init:function(b,c){this.cfg=b;this.wsconnect()},wsconnect:function(){io.wsuri="wss://"+this.cfg.rid;console.log(this.cfg.rid);"WebSocket"in window?this.sock=new WebSocket(io.wsuri):"MozWebSocket"in window?this.sock=new MozWebSocket(io.wsuri):(console.log("Browser does not support WebSocket!"),this.error=lang.wserror);var b=this;this.sock.onopen=function(){console.log("Connected to "+b.cfg.rid);$.event.trigger({type:"connectionopen"});
b.userauthenticat();b.addclient()};this.sock.binaryType="arraybuffer";this.sock.onmessage=function(c){try{if(c.data instanceof ArrayBuffer)$.event.trigger({type:"newaudio",message:c.data});else{var a=JSON.parse(c.data);if("joinroom"==a.type){console.log("New user join room "+a.users);var e=null;null!=b.uniquesids&&$.each(a.clientids,function(a,c){void 0==b.uniquesids[a]&&(e=a)});b.uniquesids=a.clientids;$.event.trigger({type:"member_added",message:a.users,newuser:e})}if("broadcastToAll"==a.type){console.log("json  : display msg");
var d="";void 0!=a.userto&&(d=a.userto);$.event.trigger({type:"newmessage",message:a.m,fromUser:a.user,toUser:d})}"userleft"==a.type&&(console.log("user logout"),d="",void 0!=a.userto&&(d=a.userto),null!=b.uniquesids&&delete b.uniquesids[a.user.userid],$.event.trigger({type:"user_logout",fromUser:a.user,message:"offline",toUser:d}));"leftroom"==a.type&&(console.log("member removed"),$.event.trigger({type:"member_removed",message:a.users}));"Unauthenticated"==a.type&&(console.log("Unauthenticated user"),
$.event.trigger({type:"authentication_failed",message:"Authentication failed"}));"Multiple_login"==a.type&&(console.log("Multiple_login"),$.event.trigger({type:"Multiple_login"}))}}catch(f){console.log("Error catched   : "+f),$.event.trigger({type:"error",message:f})}};this.sock.onerror=function(c){b.error=c;console.log("Error:"+c);$.event.trigger({type:"error",message:c})};this.sock.onclose=function(c){console.log("Connection Closed");$.event.trigger({type:"connectionclose",message:c.reason});console.log("Connection closed (wasClean = "+
c.wasClean+", code = "+c.code+", reason = '"+c.reason+"')");setTimeout(function(){b.wsconnect()},5E3)}},userauthenticat:function(){var b=JSON.stringify({cfun:"authenticate",arg:{authuser:this.cfg.authuser,authpass:this.cfg.authpass}});this.sock.send(b)},addclient:function(){var b=JSON.stringify({cfun:"joinroom",arg:{client:this.cfg.userid,roomname:this.cfg.fastchatroom_name,user:this.cfg.userobj}});this.sock.send(b)},send:function(b){var c={cfun:"broadcastToAll",arg:{msg:b}};1<arguments.length&&(c.arg.touser=
this.uniquesids[arguments[1]]);c=JSON.stringify(c);this.sock.send(c)},sendBinary:function(b){this.sock.send(b.buffer)},disconnect:function(){this.sock.onclose=function(){};this.sock.close();console.log("i am closing this connection")}};
